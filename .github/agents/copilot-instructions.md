# duGuru Development Guidelines

**Auto-generated by /speckit.analyze** | Last updated: 2026-02-25

---

## Active Feature

- **Branch**: `001-duguru-app`
- **Spec**: `specs/001-duguru-app/spec.md` (Status: Refined)
- **Plan**: `specs/001-duguru-app/plan.md`
- **Tasks**: `specs/001-duguru-app/tasks.md` (132 tasks, Phases 1–10)

---

## Active Technologies

- TypeScript 5.x strict — frontend e backend (001-duguru-app)
- React 18 + Vite 5 — frontend SPA (001-duguru-app)
- Tailwind CSS v3 + CSS custom properties — dark/light theming (001-duguru-app)
- Framer Motion — animações e transições (001-duguru-app)
- React Router v6 — roteamento SPA (001-duguru-app)
- Zustand — estado global (001-duguru-app)
- D3.js — renderização mandala natal SVG (001-duguru-app)
- react-i18next — i18n PT-BR (001-duguru-app)
- vite-plugin-pwa — PWA + service worker (001-duguru-app)
- react-helmet-async — SEO meta tags dinâmicas (001-duguru-app)
- Node.js 20 LTS + Express 4 — backend API (001-duguru-app)
- sweph (Swiss Ephemeris) — cálculos astronômicos, APENAS backend (001-duguru-app)
- Prisma ORM — acesso ao banco de dados (001-duguru-app)
- PostgreSQL — banco de dados principal (001-duguru-app)
- jose — JWT RS256 assimétrico (001-duguru-app)
- bcrypt — hash de senhas (001-duguru-app)
- Puppeteer — geração de PDF/PNG do mapa astral (001-duguru-app)
- sharp — processamento de avatar (crop circular) (001-duguru-app)
- nodemailer — envio de emails (001-duguru-app)
- Vitest + React Testing Library — testes unitários e de integração (001-duguru-app)
- Playwright + axe-core — testes E2E e acessibilidade (001-duguru-app)
- GitHub Actions — CI/CD (001-duguru-app)

---

## Project Structure

```text
duguru/                              ← raiz do workspace
├── frontend/                        ← SPA React + Vite
│   ├── public/
│   │   ├── manifest.json            ← PWA manifest
│   │   ├── sw.js                    ← service worker (vite-plugin-pwa)
│   │   ├── robots.txt
│   │   ├── sitemap.xml
│   │   └── icons/                   ← ícones PWA 192×192 e 512×512
│   ├── src/
│   │   ├── assets/
│   │   ├── components/
│   │   │   ├── ui/                  ← Button, Input, Skeleton, Toast, Modal
│   │   │   ├── chart/               ← NatalChartWheel, PlanetPanel, ChartTable, HouseSystemSelector
│   │   │   ├── horoscope/           ← HoroscopeCard, PeriodTabs, SectionBlock
│   │   │   ├── dashboard/           ← DailyPlanet, MoonPhase, DailyQuote, AlertBanner, CompatTop3
│   │   │   ├── compatibility/       ← CompatScore, SynastrySummary
│   │   │   ├── auth/                ← LoginForm, RegisterForm, ForgotPasswordForm, BirthPlaceInput
│   │   │   ├── layout/              ← BottomNav, Sidebar, TopBar, OnboardingOverlay
│   │   │   └── profile/             ← AvatarUpload, ProfileForm
│   │   ├── pages/
│   │   │   ├── WelcomePage.tsx
│   │   │   ├── LoginPage.tsx
│   │   │   ├── RegisterPage.tsx
│   │   │   ├── HomePage.tsx
│   │   │   ├── NatalChartPage.tsx
│   │   │   ├── HoroscopePage.tsx
│   │   │   ├── CompatibilityPage.tsx
│   │   │   └── ProfilePage.tsx
│   │   ├── stores/                  ← Zustand stores
│   │   │   ├── authStore.ts
│   │   │   ├── chartStore.ts
│   │   │   ├── themeStore.ts
│   │   │   └── onboardingStore.ts
│   │   ├── services/                ← axios calls to backend API
│   │   │   ├── api.ts               ← axios instance + interceptors JWT auto-refresh
│   │   │   ├── authService.ts
│   │   │   ├── chartService.ts
│   │   │   ├── horoscopeService.ts
│   │   │   ├── compatibilityService.ts
│   │   │   └── geocodingService.ts
│   │   ├── hooks/
│   │   │   ├── useAuth.ts
│   │   │   ├── useTheme.ts
│   │   │   ├── useNatalChart.ts
│   │   │   └── usePWAInstall.ts
│   │   ├── lib/
│   │   │   ├── svgChart.ts          ← helpers D3 puros para mandala
│   │   │   ├── dateUtils.ts
│   │   │   └── zodiacSymbols.ts
│   │   ├── i18n/
│   │   │   ├── index.ts
│   │   │   └── messages/
│   │   │       └── pt-BR.json       ← TODAS as strings da UI (nenhuma hardcoded)
│   │   ├── styles/
│   │   │   ├── globals.css          ← CSS custom properties (tokens light/dark)
│   │   │   └── tailwind.css
│   │   ├── router.tsx
│   │   ├── App.tsx
│   │   └── main.tsx
│   ├── tests/
│   │   ├── unit/                    ← Vitest + RTL
│   │   ├── integration/             ← Vitest (API mockada)
│   │   └── e2e/                     ← Playwright
│   ├── index.html
│   ├── vite.config.ts
│   ├── tailwind.config.ts
│   ├── tsconfig.json
│   └── package.json
│
├── backend/                         ← API Node.js + Express
│   ├── src/
│   │   ├── astro/                   ← módulo PURO Swiss Ephemeris (ZERO I/O)
│   │   │   ├── ephemeris.ts         ← calcPlanet, calcHouses, calcAspects
│   │   │   ├── moonPhase.ts
│   │   │   ├── transits.ts
│   │   │   ├── synastry.ts
│   │   │   ├── interpretationProvider.ts
│   │   │   └── interpretations/
│   │   │       ├── planets-in-signs.json    ← 120 textos curados
│   │   │       ├── planets-in-houses.json   ← 120 textos curados
│   │   │       └── transits-by-sign.json    ← 600 textos curados (horóscopo)
│   │   ├── auth/
│   │   │   ├── jwtService.ts        ← jose RS256
│   │   │   ├── passwordService.ts   ← bcrypt rounds 12
│   │   │   ├── tokenStore.ts        ← Refresh Token Rotation + deny-list
│   │   │   └── authMiddleware.ts
│   │   ├── routes/
│   │   │   ├── auth.routes.ts
│   │   │   ├── chart.routes.ts
│   │   │   ├── horoscope.routes.ts
│   │   │   ├── dashboard.routes.ts
│   │   │   ├── compatibility.routes.ts
│   │   │   ├── profile.routes.ts
│   │   │   ├── geocoding.routes.ts
│   │   │   └── health.routes.ts
│   │   ├── services/
│   │   │   ├── chartService.ts
│   │   │   ├── horoscopeService.ts
│   │   │   ├── dailyContentService.ts
│   │   │   ├── emailService.ts
│   │   │   ├── pdfService.ts        ← Puppeteer headless
│   │   │   └── geocodingService.ts  ← OpenCage → Nominatim fallback
│   │   ├── db/prisma/
│   │   │   └── schema.prisma
│   │   ├── middleware/
│   │   │   ├── rateLimiter.ts       ← 5 tentativas/15 min para login
│   │   │   ├── errorHandler.ts      ← formato: { error: { code, message, status } }
│   │   │   └── requestLogger.ts
│   │   ├── types/
│   │   └── app.ts
│   ├── tests/
│   │   ├── unit/
│   │   └── integration/
│   ├── ephemeris/                   ← arquivos .se1 (1800–2400), imutáveis
│   ├── prisma/seeds/
│   │   ├── dailyQuotes.ts           ← 365 frases PT-BR
│   │   └── compatibilityScores.ts   ← 144 registros (12×12 signos)
│   ├── tsconfig.json
│   └── package.json
│
├── .github/
│   ├── agents/
│   │   └── copilot-instructions.md  ← este arquivo
│   └── workflows/
│       ├── ci-frontend.yml
│       └── ci-backend.yml
└── specs/001-duguru-app/
    ├── spec.md
    ├── plan.md
    └── tasks.md
```

---

## Commands

```bash
# Frontend
cd frontend
npm run dev          # Vite dev server
npm run build        # Build de produção
npm run type-check   # tsc --noEmit
npm run lint         # ESLint @typescript-eslint/recommended-type-checked
npm run test         # Vitest com cobertura
npm run test:e2e     # Playwright

# Backend
cd backend
npm run dev          # ts-node-dev / nodemon
npm run build        # tsc
npm run type-check   # tsc --noEmit
npm run lint         # ESLint
npm run test         # Vitest com cobertura
npx prisma migrate dev   # aplicar migrações
npx prisma db seed       # executar seeds (frases + scores de compatibilidade)
npx prisma studio        # GUI do banco de dados
```

---

## Code Style

### TypeScript (ambos os projetos)

- `strict: true` + `noUncheckedIndexedAccess` + `exactOptionalPropertyTypes` + `noImplicitReturns` + `noFallthroughCasesInSwitch` — **obrigatórios**
- **Proibido `any`** — use `unknown` + narrowing explícito; exceções com comentário `// eslint-disable-next-line @typescript-eslint/no-explicit-any` + justificativa
- **Proibido `as` (type assertion)** sem guard de runtime precedendo imediatamente
- Interfaces públicas de módulos: JSDoc com `@param`, `@returns`, `@throws`
- Tipos gerados (Prisma, OpenAPI): nunca editar manualmente; ficam em diretórios separados

### CSS / Theming

- **Zero cores hardcoded** em componentes — sempre `var(--color-*)` ou classes Tailwind mapeadas para CSS variables
- Todos os tokens em `frontend/src/styles/globals.css`:

```css
/* Light Mode */
:root {
  --color-bg: #faeee7;
  --color-main: #e8e4e6;
  --color-secondary: #ffc6c7;
  --color-tertiary: #c3f0ca;
  --color-headline: #33272a;
  --color-paragraph: #594a4e;
  --color-button: #f25f4c;
  --color-button-text: #33272a;
  --color-highlight: #ff8ba7;
  --color-link: #f25f4c;
}

/* Dark Mode */
[data-theme="dark"] {
  --color-bg: #004643;
  --color-secondary: #ffc6c7;
  --color-headline: #fffffe;
  --color-paragraph: #abd1c6;
  --color-button: #f9bc60;
  --color-button-text: #33272a;
  --color-highlight: #ff8ba7;
  --color-link: #f9bc60;
}
```

### i18n

- **Zero strings hardcoded** em componentes `.tsx` — todas em `frontend/src/i18n/messages/pt-BR.json`
- Datas/horas/números: sempre `new Intl.DateTimeFormat('pt-BR', ...).format(date)` ou `Intl.NumberFormat('pt-BR')` — **nunca** `.toLocaleDateString()` sem argumento
- Nomes de planetas, signos, casas, aspectos: keys de i18n (ex: `t('planets.sun')`)

### Módulo Astronômico (`backend/src/astro/`)

- **100% puro** — funções recebem dados, retornam dados; **zero I/O**, zero efeitos colaterais
- Todos os arquivos neste módulo devem ser testáveis em isolamento sem mocks de banco ou rede
- Cobertura mínima: **100%** (enforced por threshold no Vitest)
- Tolerância de erro: < 0.001° para posições planetárias

### Segurança (Auth)

- JWT de acesso: RS256, expira em **15 minutos**, **nunca** em localStorage/sessionStorage
- Refresh token: cookie `HttpOnly; Secure; SameSite=Strict`, expira em **7 dias**
- Refresh Token Rotation: cada uso invalida o token anterior
- Rate limiting no login: 5 tentativas / 15 minutos (`express-rate-limit`)
- Bloqueio de conta: 5 falhas consecutivas → bloqueia 15 min + email de notificação

### Testes

- Testes escritos **ANTES** da implementação (TDD) para módulo astro, auth e regras de negócio
- Testes devem **FALHAR** na primeira execução antes da implementação
- Mocks do Swiss Ephemeris usam fixtures derivadas de dados reais (Astro.com), nunca valores inventados
- Testes E2E: chromium + firefox + webkit; viewport mobile padrão 375×812 px

### Acessibilidade

- Touch targets mínimos: 44×44 px
- Toda cor verificada para contraste (4.5:1 texto normal, 3:1 texto grande) em ambos os temas
- Gráficos SVG: `role="img"` + `aria-describedby` apontando para tabela de posições
- Modais e drawers: `role="dialog"` + `aria-modal="true"` + foco preso + `Escape` para fechar
- `prefers-reduced-motion` respeitado por todas as animações Framer Motion

---

## Gates de CI (todo PR — BLOQUEANTES)

| Gate | Comando | Threshold |
|---|---|---|
| Type check frontend | `npm run type-check` | Zero erros |
| Type check backend | `npm run type-check` | Zero erros |
| Lint frontend | `npm run lint` | Zero warnings/errors |
| Lint backend | `npm run lint` | Zero warnings/errors |
| Vitest frontend | `npm run test` | Cobertura global ≥ 80% |
| Vitest backend | `npm run test` | Global ≥ 80%; astro 100%; auth 95% |
| Playwright E2E | `npm run test:e2e` | Fluxos críticos passando |
| axe-core | integrado ao Playwright | Zero violações A/AA |
| Lighthouse CI | `lhci autorun` | Performance ≥ 85; LCP ≤ 2.5 s; A11y ≥ 95; SEO ≥ 90 |
| Bundle size | script customizado | Chunk inicial ≤ 150 KB gzip |
| i18n lint | script customizado | Zero strings hardcoded em TSX |

---

## Decisões Arquiteturais Registradas

| Decisão | Escolha | Razão |
|---|---|---|
| sweph roda onde? | **Backend only** | Binding nativo Node.js; não compila para browser; evita WASM no bundle inicial |
| Cache | **PostgreSQL com TTL** (não Redis) | Simplifica infra no MVP; Redis adicionado quando múltiplas instâncias forem necessárias |
| Mandala SVG | **D3.js manual** (não lib astro-chart) | Controle total de acessibilidade e interatividade; libs prontas têm a11y inadequada |
| i18n | **react-i18next** (não next-intl) | Equivalente para SPA Vite/React; next-intl é otimizado para Next.js App Router |
| Interpretações | **Banco curado JSON** (não LLM) | Custo zero; funciona offline; conteúdo revisável; `InterpretationProvider` abstrai fonte |
| Horóscopo | **Algorítmico via sweph + textos curados** | Precisão baseada em cálculo real; sem dependência de API externa |
| Auth | **jose + bcrypt** (não Firebase Auth) | Controle total dos tokens; sem vendor lock-in; alinhado ao Princípio III da Constituição |
| Banco | **PostgreSQL + Prisma** (não Firestore) | Queries relacionais, transações ACID, type-safety; Firestore tem custo imprevisível |
| Horóscopo ↔ API externa | Rejeitado FreeAstrologyAPI.com | Garante precisão, funciona offline, sem dependência de terceiros |

---

## Project Status

| Phase | Tarefas | Status |
|---|---|---|
| Phase 1 — Fundação (T001–T016) | Monorepo, Prisma schema, JWT RS256, testes auth | ✅ Completa |
| Phase 2 — Auth UI (T017–T031) | Páginas login/register/forgot/reset, onboarding | ✅ Completa |
| Phase 3 — Perfil & Geocodificação (T032–T056) | Profile routes, avatar upload, geocoding, i18n | ✅ Completa |
| Phase 4 — Mapa Natal (T057–T080) | sweph, ephemeris, chartService, mandala D3 SVG, NatalChartPage | ✅ Completa |
| Phase 5 — Dashboard / Home (T081–T092) | dailyContentService, dashboard.routes, DailyPlanet, MoonPhase, DailyQuote, AlertBanner, CompatTop3, seeds | ✅ Completa |
| Phase 6 — Horóscopo Personalizado (T093–T102) | transits-by-sign.json, horoscopeService, horoscope.routes, PeriodTabs, SectionBlock, HoroscopePage | ✅ Completa |
| Phase 7 — Onboarding (T103–T105) | onboardingStore, OnboardingOverlay, App.tsx integration | ✅ Completa |
| Phase 8 — Compatibilidade e Sinastria (T106–T112) | synastry tests, compatibility.routes, CompatScore D3 radar, SynastrySummary | ✅ Completa |
| Phase 9 — PWA e Offline (T113–T117) | vite-plugin-pwa, manifest SVG icon, usePWAInstall, pwa.spec.ts offline tests | ✅ Completa |
| Phase 10 — Polish (T118–T132) | BottomNav, Sidebar, a11y.spec.ts (axe-core+contraste), bundle size CI, og: SEO tags, robots.txt, sitemap.xml, i18n/Intl lint scripts, Sentry frontend+backend, netlify.toml, Dockerfile | ✅ Completa |

**Testes backend**: 124/125 passando (1 falha pré-existente em `ephemeris.test.ts` — precisão da Lua, fora do escopo de todas as phases)

**Status**: ✅ TODAS AS 10 PHASES COMPLETAS (T001–T132). Projeto pronto para deploy.

## Recent Changes

- 001-duguru-app (2026-02-25): Phases 9+10 completas (T113–T132) — PWA: `vite.config.ts` VitePWA NetworkFirst/CacheFirst, `public/icons/icon.svg` (crystal ball design), `usePWAInstall.ts` (BeforeInstallPromptEvent), botão "Instalar app" em ProfilePage, `pwa.spec.ts` (offline test + manifest + icon); Polish: `BottomNav.tsx` (mobile, Tailwind lg:hidden), `Sidebar.tsx` (desktop, lg:flex + avatar), router.tsx atualizado (Sidebar+BottomNav em ProtectedRoute, pb-16 mobile), `a11y.spec.ts` (axe-core WCAG A/AA em 8 páginas + contraste temas claro/escuro), SEO og: tags em WelcomePage+LoginPage+RegisterPage (og:title/description/image/url, canonical, twitter:card), `robots.txt` + `sitemap.xml` (páginas públicas), `check-i18n.mjs` + `check-intl.mjs` + npm scripts `lint:i18n` / `check:intl` / `check:bundle`, `check-bundle-size.mjs` (≤150KB gzip), CI atualizado (i18n lint + Intl check + bundle size gate), Sentry em `main.tsx` (@sentry/react, canary DSN, replays) e `app.ts` (@sentry/node, prismaIntegration, setupExpressErrorHandler), `netlify.toml` (SPA redirect + CSP + HSTS + cache headers), `backend/Dockerfile` (multi-stage Node 20 Alpine, health check), i18n pt-BR expandido (nav.sidebarLabel, nav.avatarAlt, profile.pwaInstallHint, profile.pwaInstalled); frontend+backend tsc ✅ clean; backend 124/125 testes (mesma falha pré-existente)
- 001-duguru-app (2026-02-25): Phases 7+8 completas — `onboardingStore`, `OnboardingOverlay` (4 passos, focus trap, Escape, aria-modal), integração em `App.tsx` (OnboardingStarter detecta `user.onboardingDone === false`); `compatibility.routes.ts` (`GET /api/compatibility` cache Neon, `POST /api/synastry` Zod + buildPositions); `synastry.ts` reescrito (3-tier orbs 8°/6°/4°, intensity 0–100, `calcSynastryScore` romance/amizade/trabalho 20–95); `CompatScore.tsx` (D3 radar 3 eixos + Framer Motion bars); `SynastrySummary.tsx` (lista aspectos, ícones unicode, intensidade dots); `CompatibilityPage.tsx` completa (tabs signos/sinastria); `compatibilityService.ts` + `useCompatibility.ts`; i18n pt-BR expandido (25+ chaves); 24+ testes unitários sinastria + 10 integração compatibility; backend 124/125 testes passando; tsc ✅ clean em ambos
- 001-duguru-app (2026-02-25): Phases 5+6 completas — `dailyContentService`, `dashboard.routes` (`GET /api/daily`), seeds 365 frases + 144 scores compatibilidade, 5 componentes dashboard (`DailyPlanet`, `MoonPhase`, `DailyQuote`, `AlertBanner`, `CompatTop3`), `horoscopeService` (cache 1h), `horoscope.routes` (`GET /api/horoscope/:period`), `transits-by-sign.json` (120 chaves), `PeriodTabs`, `SectionBlock`, `HoroscopePage` atualizada, testes E2E dashboard + horóscopo; corrigidos bugs pré-existentes em `auth.routes.test.ts` e `chart.routes.test.ts` (factory mock vitest hoisting); backend 101/102 testes passando; tsc ✅ clean em ambos
- 001-duguru-app (2026-02-25): Phase 4 completa — sweph v2 wrapper (`ephemeris.ts`), `chartService`, `chart.routes`, mandala SVG D3 (`NatalChartWheel`), `ChartTable`, `PlanetPanel`, `HouseSystemSelector`, `NatalChartPage`, `useNatalChart`, `chartService` frontend, `zodiacSymbols`, testes E2E; backend + frontend tsc ✅ clean
- 001-duguru-app (2026-02-24): Spec Refined + Plan completo + 132 tasks em 10 phases; Phases 1–3 completas

<!-- MANUAL ADDITIONS START -->
<!-- MANUAL ADDITIONS END -->
